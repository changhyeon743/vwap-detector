<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VWAP Trading Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            height: 100vh;
            overflow: hidden;
        }
        .dashboard { display: grid; grid-template-columns: 1fr 260px; height: 100vh; }

        /* Chart Area */
        .chart-area { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .toolbar {
            display: flex; align-items: center; gap: 10px; padding: 6px 12px;
            background: #1e222d; border-bottom: 1px solid #2a2e39; flex-shrink: 0;
        }
        .symbol-select {
            padding: 5px 10px; background: #2a2e39; border: 1px solid #363a45;
            border-radius: 4px; color: #d1d4dc; font-size: 13px; min-width: 120px;
        }
        .tf-group { display: flex; gap: 3px; }
        .tf-btn {
            padding: 5px 10px; background: #2a2e39; border: 1px solid #363a45;
            border-radius: 4px; color: #787b86; cursor: pointer; font-size: 12px;
        }
        .tf-btn:hover { background: #363a45; }
        .tf-btn.active { background: #2962ff; color: white; border-color: #2962ff; }
        .status { margin-left: auto; display: flex; align-items: center; gap: 6px; font-size: 11px; color: #787b86; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #f23645; }
        .status-dot.ok { background: #089981; }
        #chart-container { flex: 1; position: relative; min-height: 400px; }

        /* Signal Bar */
        .signal-bar {
            height: 100px; background: #1e222d; border-top: 1px solid #2a2e39;
            padding: 6px 12px; overflow-x: auto; flex-shrink: 0;
        }
        .signal-bar h3 { font-size: 10px; color: #787b86; text-transform: uppercase; margin-bottom: 6px; }
        .signals-list { display: flex; gap: 6px; }
        .sig-card {
            flex-shrink: 0; padding: 6px 10px; background: #2a2e39; border-radius: 5px;
            border-left: 3px solid; min-width: 120px; font-size: 11px;
        }
        .sig-card.long { border-color: #089981; }
        .sig-card.short { border-color: #f23645; }
        .sig-card .sym { font-weight: 600; }
        .sig-card .type { margin-top: 2px; }
        .sig-card.long .type { color: #089981; }
        .sig-card.short .type { color: #f23645; }
        .sig-card .info { color: #787b86; font-size: 10px; margin-top: 2px; }

        /* Sidebar */
        .sidebar {
            background: #1e222d; border-left: 1px solid #2a2e39;
            display: flex; flex-direction: column; overflow: hidden; font-size: 12px;
        }
        .sidebar-header {
            padding: 10px 12px; border-bottom: 1px solid #2a2e39;
            display: flex; align-items: center; justify-content: space-between;
        }
        .sidebar-header h2 { font-size: 13px; font-weight: 600; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        .section { margin-bottom: 12px; }
        .section h3 {
            font-size: 10px; color: #787b86; text-transform: uppercase;
            margin-bottom: 6px; padding-bottom: 3px; border-bottom: 1px solid #2a2e39;
        }
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .row label { color: #d1d4dc; }
        .row input[type="number"], .row select {
            width: 70px; padding: 3px 6px; background: #2a2e39; border: 1px solid #363a45;
            border-radius: 3px; color: #d1d4dc; font-size: 11px; text-align: right;
        }
        .row select { width: 80px; text-align: left; }
        .row input[type="checkbox"] { width: 14px; height: 14px; }
        .tf-chips { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px; }
        .chip {
            padding: 3px 6px; background: #2a2e39; border: 1px solid #363a45;
            border-radius: 3px; font-size: 10px; cursor: pointer;
        }
        .chip:hover { background: #363a45; }
        .chip.on { background: #2962ff; border-color: #2962ff; color: white; }
        .sidebar-footer { padding: 10px; border-top: 1px solid #2a2e39; }
        .btn {
            width: 100%; padding: 8px; border: none; border-radius: 5px;
            font-size: 12px; font-weight: 600; cursor: pointer;
        }
        .btn-primary { background: #2962ff; color: white; }
        .btn-primary:hover { background: #1e53e4; }
        .btn-secondary { background: #363a45; color: #d1d4dc; margin-top: 6px; }

        /* Legend */
        .legend {
            position: absolute; top: 8px; left: 8px; background: rgba(30,34,45,0.9);
            padding: 6px 10px; border-radius: 5px; font-size: 11px; z-index: 10;
        }
        .legend-row { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .legend-row:last-child { margin-bottom: 0; }
        .legend-color { width: 10px; height: 2px; border-radius: 1px; }
        .legend-val { font-family: monospace; }

        /* Toast */
        .toast {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%) translateY(20px);
            padding: 8px 16px; background: #089981; color: white; border-radius: 5px;
            font-size: 12px; opacity: 0; transition: all 0.3s; z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.err { background: #f23645; }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .sidebar { display: none; }
        }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="chart-area">
        <div class="toolbar">
            <select class="symbol-select" id="symbolSelect"><option>Loading...</option></select>
            <div class="tf-group" id="tfGroup">
                <button class="tf-btn" data-tf="1m">1m</button>
                <button class="tf-btn" data-tf="3m">3m</button>
                <button class="tf-btn active" data-tf="5m">5m</button>
                <button class="tf-btn" data-tf="15m">15m</button>
                <button class="tf-btn" data-tf="1h">1h</button>
            </div>
            <select class="symbol-select" id="tzSelect" style="width:70px;">
                <option value="0">UTC</option>
                <option value="9" selected>KST</option>
            </select>
            <div class="status"><span class="status-dot" id="dot"></span><span id="statTxt">Connecting...</span></div>
        </div>
        <div id="chart-container">
            <div class="legend" id="legend">
                <div class="legend-row"><span class="legend-color" style="background:#2962ff"></span>VWAP: <span class="legend-val" id="lVwap">-</span></div>
                <div class="legend-row"><span class="legend-color" style="background:#ff9800"></span>Upper: <span class="legend-val" id="lUp">-</span></div>
                <div class="legend-row"><span class="legend-color" style="background:#ff9800"></span>Lower: <span class="legend-val" id="lLo">-</span></div>
            </div>
        </div>
        <div class="signal-bar">
            <h3>Signal History</h3>
            <div class="signals-list" id="sigList"><div class="sig-card"><div class="sym">No signals yet</div></div></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header"><h2>Settings</h2></div>
        <div class="sidebar-content">
            <div class="section"><h3>Trading</h3>
                <div class="row"><label>Auto Trade</label><input type="checkbox" id="s_auto"></div>
                <div class="row"><label>Leverage</label><input type="number" id="s_lev" min="1" max="100"></div>
                <div class="row"><label>Size (USDT)</label><input type="number" id="s_size" min="1"></div>
                <div class="row"><label>SL ATR Mult</label><input type="number" id="s_slbuf" min="0" step="0.1"></div>
            </div>
            <div class="section"><h3>Strategy</h3>
                <div class="row"><label>Band Mult</label><input type="number" id="s_band" min="0.5" max="5" step="0.1"></div>
                <div class="row"><label>Exit Long</label><select id="s_exl"><option value="VWAP">VWAP</option><option value="Deviation Band">Dev Band</option><option value="None">None</option></select></div>
                <div class="row"><label>Exit Short</label><select id="s_exs"><option value="VWAP">VWAP</option><option value="Deviation Band">Dev Band</option><option value="None">None</option></select></div>
                <div class="row"><label>Min Strength</label><input type="number" id="s_str" min="0" max="1" step="0.05"></div>
                <div class="row"><label>Min Vol Ratio</label><input type="number" id="s_vol" min="0" max="2" step="0.05"></div>
            </div>
            <div class="section"><h3>Safety Exit</h3>
                <div class="row"><label>Enabled</label><input type="checkbox" id="s_safe"></div>
                <div class="row"><label>Opposing Bars</label><input type="number" id="s_bars" min="1" max="10"></div>
            </div>
            <div class="section"><h3>Direction</h3>
                <div class="row"><label>Allow Longs</label><input type="checkbox" id="s_long"></div>
                <div class="row"><label>Allow Shorts</label><input type="checkbox" id="s_short"></div>
            </div>
            <div class="section"><h3>Monitor</h3>
                <div class="row"><label>Top OI</label><input type="number" id="s_oi" min="1" max="50"></div>
                <div class="row"><label>Interval (s)</label><input type="number" id="s_int" min="10"></div>
                <div><label style="display:block;margin-bottom:3px;">Timeframes</label>
                    <div class="tf-chips" id="tfChips">
                        <span class="chip" data-tf="1m">1m</span><span class="chip" data-tf="3m">3m</span>
                        <span class="chip" data-tf="5m">5m</span><span class="chip" data-tf="15m">15m</span>
                        <span class="chip" data-tf="30m">30m</span><span class="chip" data-tf="1h">1h</span>
                    </div>
                </div>
            </div>
            <div class="section"><h3>Display</h3>
                <div class="row"><label>Debug Mode</label><input type="checkbox" id="s_dbg"></div>
                <div class="row"><label>Send Chart</label><input type="checkbox" id="s_snd"></div>
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            <button class="btn btn-secondary" onclick="loadSettings()">Reload</button>
        </div>
    </div>
</div>
<div class="toast" id="toast"></div>

<script>
let chart, candleSeries, vwapLine, upperLine, lowerLine;
let settings = {}, currentSymbol = '', currentTF = '5m';
function getTzOffset() { return parseInt(document.getElementById('tzSelect').value) * 3600; }

document.addEventListener('DOMContentLoaded', async () => {
    // Wait for layout to be computed before initializing chart
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    initChart();
    await loadSettings();
    await loadSymbols();
    await loadSignals();
    // Auto-refresh disabled - manual refresh only
    // setInterval(async () => { await loadChartData(); await loadSignals(); }, 30000);

    document.querySelectorAll('.tf-btn').forEach(b => b.addEventListener('click', () => {
        document.querySelectorAll('.tf-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        currentTF = b.dataset.tf;
        loadChartData();
    }));
    document.getElementById('symbolSelect').addEventListener('change', e => { currentSymbol = e.target.value; loadChartData(); });
    document.getElementById('tzSelect').addEventListener('change', () => loadChartData());
    document.querySelectorAll('.chip').forEach(c => c.addEventListener('click', () => c.classList.toggle('on')));
});

function initChart() {
    const el = document.getElementById('chart-container');
    chart = LightweightCharts.createChart(el, {
        width: el.clientWidth, height: el.clientHeight,
        layout: { background: { type: 'solid', color: '#131722' }, textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        rightPriceScale: { borderColor: '#2a2e39' },
        timeScale: { borderColor: '#2a2e39', timeVisible: true, secondsVisible: false },
    });
    candleSeries = chart.addCandlestickSeries({ upColor: '#089981', downColor: '#f23645', borderUpColor: '#089981', borderDownColor: '#f23645', wickUpColor: '#089981', wickDownColor: '#f23645' });
    vwapLine = chart.addLineSeries({ color: '#2962ff', lineWidth: 2 });
    upperLine = chart.addLineSeries({ color: '#ff9800', lineWidth: 1, lineStyle: 2 });
    lowerLine = chart.addLineSeries({ color: '#ff9800', lineWidth: 1, lineStyle: 2 });
    window.addEventListener('resize', () => chart.applyOptions({ width: el.clientWidth, height: el.clientHeight }));
    chart.subscribeCrosshairMove(p => {
        if (p.time) {
            const v = p.seriesData.get(vwapLine), u = p.seriesData.get(upperLine), l = p.seriesData.get(lowerLine);
            if (v) document.getElementById('lVwap').textContent = v.value.toFixed(2);
            if (u) document.getElementById('lUp').textContent = u.value.toFixed(2);
            if (l) document.getElementById('lLo').textContent = l.value.toFixed(2);
        }
    });
}

async function loadSymbols() {
    try {
        const r = await fetch('/api/symbols');
        if (r.ok) {
            const d = await r.json();
            const sel = document.getElementById('symbolSelect');
            sel.innerHTML = d.symbols.map((s,i) => `<option value="${s}" ${i===0?'selected':''}>${s.replace('/USDT:USDT','').replace(':USDT','')}</option>`).join('');
            currentSymbol = d.symbols[0] || '';
            setStatus(true);
            loadChartData();
        }
    } catch(e) { setStatus(false); }
}

async function loadChartData() {
    if (!currentSymbol) return;
    try {
        const r = await fetch(`/api/ohlcv?symbol=${encodeURIComponent(currentSymbol)}&timeframe=${currentTF}`);
        if (r.ok) {
            const d = await r.json();
            candleSeries.setData(d.candles.map(c => ({ time: c.time + getTzOffset(), open: c.open, high: c.high, low: c.low, close: c.close })));
            if (d.vwap) vwapLine.setData(d.vwap.map(v => ({ time: v.time + getTzOffset(), value: v.value })));
            if (d.upper_band) upperLine.setData(d.upper_band.map(v => ({ time: v.time + getTzOffset(), value: v.value })));
            if (d.lower_band) lowerLine.setData(d.lower_band.map(v => ({ time: v.time + getTzOffset(), value: v.value })));
            if (d.signals?.length) candleSeries.setMarkers(d.signals.map(s => ({ time: s.time + getTzOffset(), position: s.type==='LONG'?'belowBar':'aboveBar', color: s.type==='LONG'?'#089981':'#f23645', shape: s.type==='LONG'?'arrowUp':'arrowDown', text: s.type })));
            if (d.vwap?.length) { const l=d.vwap[d.vwap.length-1]; document.getElementById('lVwap').textContent=l.value.toFixed(2); }
            if (d.upper_band?.length) document.getElementById('lUp').textContent=d.upper_band[d.upper_band.length-1].value.toFixed(2);
            if (d.lower_band?.length) document.getElementById('lLo').textContent=d.lower_band[d.lower_band.length-1].value.toFixed(2);
            chart.timeScale().fitContent();
        }
    } catch(e) { console.error(e); }
}

async function loadSignals() {
    try {
        const r = await fetch('/api/signals');
        if (r.ok) {
            const d = await r.json();
            const list = document.getElementById('sigList');
            if (!d.signals?.length) { list.innerHTML = '<div class="sig-card"><div class="sym">No signals</div></div>'; return; }
            list.innerHTML = d.signals.slice(0,20).map(s => `<div class="sig-card ${s.type.toLowerCase()}"><div class="sym">${s.symbol.replace('/USDT:USDT','').replace(':USDT','')}</div><div class="type">${s.type} @ ${s.timeframe}</div><div class="info">$${s.price?.toFixed(2)||'-'} | ${new Date(s.time).toLocaleString('ko-KR', {timeZone:'Asia/Seoul', hour:'2-digit', minute:'2-digit'})}</div></div>`).join('');
        }
    } catch(e) {}
}

async function loadSettings() {
    try {
        const r = await fetch('/api/settings');
        if (r.ok) { settings = await r.json(); populateSettings(); }
    } catch(e) {}
}

function populateSettings() {
    const s = settings;
    document.getElementById('s_auto').checked = s.trading?.auto_trade === true;
    document.getElementById('s_lev').value = s.trading?.leverage || 20;
    document.getElementById('s_size').value = s.trading?.order_size_usdt || 100;
    document.getElementById('s_slbuf').value = s.trading?.sl_buffer_atr_mult || 0.5;
    document.getElementById('s_band').value = s.strategy?.band_entry_mult || 2.0;
    document.getElementById('s_exl').value = s.strategy?.exit_mode_long || 'VWAP';
    document.getElementById('s_exs').value = s.strategy?.exit_mode_short || 'VWAP';
    document.getElementById('s_str').value = s.strategy?.min_strength || 0.7;
    document.getElementById('s_vol').value = s.strategy?.min_vol_ratio || 0.05;
    document.getElementById('s_safe').checked = s.safety_exit?.enabled !== false;
    document.getElementById('s_bars').value = s.safety_exit?.num_opposing_bars || 2;
    document.getElementById('s_long').checked = s.trade_direction?.allow_longs !== false;
    document.getElementById('s_short').checked = s.trade_direction?.allow_shorts !== false;
    document.getElementById('s_oi').value = s.monitor?.top_oi_count || 20;
    document.getElementById('s_int').value = s.monitor?.check_interval || 60;
    document.getElementById('s_dbg').checked = s.display?.debug_mode === true;
    document.getElementById('s_snd').checked = s.display?.send_chart === true;
    const tfs = s.monitor?.timeframes || ['5m'];
    document.querySelectorAll('.chip').forEach(c => c.classList.toggle('on', tfs.includes(c.dataset.tf)));
}

function collectSettings() {
    const tfs = []; document.querySelectorAll('.chip.on').forEach(c => tfs.push(c.dataset.tf));
    return {
        trading: { auto_trade: document.getElementById('s_auto').checked, leverage: +document.getElementById('s_lev').value, order_size_usdt: +document.getElementById('s_size').value, position_check_interval: settings.trading?.position_check_interval||10, sl_buffer_atr_mult: +document.getElementById('s_slbuf').value },
        strategy: { band_entry_mult: +document.getElementById('s_band').value, exit_mode_long: document.getElementById('s_exl').value, exit_mode_short: document.getElementById('s_exs').value, target_long_deviation: settings.strategy?.target_long_deviation||2.0, target_short_deviation: settings.strategy?.target_short_deviation||2.0, min_strength: +document.getElementById('s_str').value, min_vol_ratio: +document.getElementById('s_vol').value },
        safety_exit: { enabled: document.getElementById('s_safe').checked, num_opposing_bars: +document.getElementById('s_bars').value },
        trade_direction: { allow_longs: document.getElementById('s_long').checked, allow_shorts: document.getElementById('s_short').checked },
        monitor: { timeframes: tfs.length?tfs:['5m'], top_oi_count: +document.getElementById('s_oi').value, check_interval: +document.getElementById('s_int').value },
        filters: settings.filters || { no_trade_around_0900: true },
        timezone: settings.timezone || { session_timezone: 'UTC', display_timezone: 'Asia/Seoul' },
        display: { debug_mode: document.getElementById('s_dbg').checked, send_chart: document.getElementById('s_snd').checked, chart_server_port: settings.display?.chart_server_port||8080 }
    };
}

async function saveSettings() {
    try {
        const r = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(collectSettings()) });
        if (r.ok) { settings = collectSettings(); showToast('Saved!'); } else showToast('Failed', true);
    } catch(e) { showToast('Error', true); }
}

function setStatus(ok) { document.getElementById('dot').classList.toggle('ok', ok); document.getElementById('statTxt').textContent = ok ? 'Connected' : 'Disconnected'; }
function showToast(msg, err=false) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (err?' err':''); setTimeout(() => t.className='toast', 2500); }
</script>
</body>
</html>
